<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Pegmatite: Pegmatite design overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Pegmatite
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Pegmatite design overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is a fork and extensive rewrite of Achilleas Margaritis's ParserLib. It has the following goals:</p>
<ul>
<li>Idiomatic C++11</li>
<li>Simple use</li>
<li>Reuseable, reentrant grammars with multiple action delegates</li>
<li>No dependency on RTTI / exceptions (usable in embedded contexts)</li>
</ul>
<p>It has the following explicit non-goals:</p>
<ul>
<li>High performance (ease of use or modification should not be sacrificed in the name of performance)</li>
<li>Compatibility with the old ParserLib</li>
</ul>
<h2>Design outline </h2>
<p>All rules should be immutable after creation. Ideally they'd be constexpr, but this is likely not to be possible. They should have no state associated with them, however, and so parsing should be entirely reentrant. State, for a grammar, is in two categories:</p>
<ul>
<li>The current parsing state</li>
<li>The actions to be performed when parsing</li>
</ul>
<p>The actions can also be immutable (they don't change over a parse, at least), but should not be tied to the grammar. It should be possible to write one singleton class encapsulating the grammar, with members for the rules, and singleton subclasses (or, ideally, delegates) providing parser actions. The parsing state should be entirely contained within a context object and so the same grammar can be used from multiple threads and can be used for compilation, syntax highlighting, and so on.</p>
<h2>Defining a grammar </h2>
<p>You can create freestanding <code>Rule</code> instances, however the recommended way of creating a grammar is to place each rule inside a class. The Calculator example follows this pattern, with a <code>CalculatorGrammar</code> class containing one field for each rule. This is recommended for two reasons:</p>
<p>1) It allows lazy creation, rather than requiring the rules to be instantiated on program creation. This gives faster start-up times and means that memory is only used when the grammar is actually used. 2) It improves encapsulation. Although it is completely safe to refer to rules in other grammars, placing them in a class makes it easy for people binding actions to the grammar to identify all of the rules that they must (or, might want to) provide actions for.</p>
<p>Simple character or string recognising expressions can be created using the <code>_E</code> custom literal suffix. For example <code>"int"_E</code> creates an expression that will match the literal string "int". This is useful for terminals.</p>
<p>You can define more complex operations from these by using the following operators (where <code>a</code> and <code>b</code> are expressions):</p>
<ul>
<li><code>*a</code> matches zero or more instances of <code>a</code></li>
<li><code>+a</code> matches one or more instances of <code>a</code></li>
<li><code>-a</code> matches zero or one instance of <code>a</code></li>
<li><code>a &gt;&gt; b</code> matches <code>a</code> and then <code>b</code></li>
<li><code>a | b</code> matches either <code>a</code> or <code>b</code></li>
</ul>
<p>Newline rules have no special meaning in parsing, but are used to increment the line counter for input ranges. If you declare a rule as matching a newline, it will increment the line counter every time it is successfully matched.</p>
<p>Whitespace rules allow implicit whitespace in between all non-terminal expressions (sequences).</p>
<h2>Building an AST </h2>
<p>The <code>ASTContainer</code> class is intended to be used as the superclass for most AST nodes. Any <code>ASTPtr</code> and <code>ASTList</code> fields of subclasses of this class will automatically be created from the AST stack. Each AST class that is constructed is pushed onto the stack in the order that it is constructed and then popped off by its parents.</p>
<p>AST nodes do not, by default, keep around the <code>InputRange</code> of the text that they matched. This is to save space for cases where it is not required. If you intend to do helpful error reporting after semantic analysis, then it is strongly recommended that you do keep such a reference.</p>
<p>After you have defined your grammar and AST, all that remains is to bind the two together. To do this, create a subclass of <code>ASTParserDelegate</code>, with one <code>BindAST</code> field for each AST node, initialised with the corresponding grammar rule. The following is the parser for the Calculator example: </p><pre class="fragment">class CalculatorParser : public ASTParserDelegate
{
    BindAST&lt;AST::Number&gt; num = CalculatorGrammar::get().num;
    BindAST&lt;AST::AddExpression&gt; add = CalculatorGrammar::get().add_op;
    BindAST&lt;AST::SubtractExpression&gt; sub = CalculatorGrammar::get().sub_op;
    BindAST&lt;AST::MultiplyExpression&gt; mul = CalculatorGrammar::get().mul_op;
    BindAST&lt;AST::DivideExpression&gt; div = CalculatorGrammar::get().div_op;
public:
    const CalculatorGrammar &amp;g = CalculatorGrammar::get();
};
</pre><p>Invoking the <code>parse()</code> method on this class will cause an <code>AST::Number</code> class to be created for every terminal matching the <code>num</code> rule in the grammar, and so on. Note that this parser is reentrant. It is safe to use it from multiple threads to parse different strings. It is therefore safe to also make the parser a singleton.</p>
<h2>RTTI Usage </h2>
<p>ParserLib requires RTTI for one specific purpose: down-casting from <code>ast_node</code> to a subclass (and checking that the result really is of that class). If you are using RTTI in the rest of your application, then you can instruct ParserLib to use RTTI for these casts by defining the <code>USE_RTTI</code> macro before including the ParserLib headers and when building ParserLib.</p>
<p>If you do not wish to depend on RTTI, then ParserLib provides a macro that you can use in your own AST classes that will provide the required virtual functions to implement ad-hoc RTTI for this specific use. You use them like this: </p><pre class="fragment">class MyASTClass : parserlib::ast_node
{
    /* Your methods go here. */
    PARSELIB_RTTI(MyASTClass, parserlib::ast_node)
};
</pre><p>This macro will be compiled away if you do define <code>USE_RTTI</code>, so you can provide grammars built with ParserLib that don't force consumers to use or not-use RTTI. It is also completely safe to build without <code>USE_RTTI</code>, but still compile with RTTI.</p>
<h2>What is Pegmatite </h2>
<p>Pegmatite is a very crystalline, intrusive igneous rock composed of interlocking crystals usually larger than 2.5 cm in size.</p>
<p>It is also a Parsing Expression Grammar library that rocks!</p>
<h2>To do </h2>
<p>Not in order:</p>
<ul>
<li>Write parameterised delegate for generating semantic HTML markup</li>
<li>Check whether the <code>USE_RTTI</code> setting for the headers and library had to match it would be nice if it didn't... </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Aug 18 2016 11:52:42 for Pegmatite by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
