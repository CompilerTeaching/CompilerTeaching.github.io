<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>Pegmatite: compiler.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Pegmatite
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">compiler.cc</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * Copyright (c) 2014 David Chisnall</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * this software and associated documentation files (the &quot;Software&quot;), to deal in</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * the Software without restriction, including without limitation the rights to</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * the Software, and to permit persons to whom the Software is furnished to do so,</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * subject to the following conditions:</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * The above copyright notice and this permission notice shall be included in all</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * copies or substantial portions of the Software.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#define LLVM_BEFORE(major,minor)\</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">    ((LLVM_MAJOR &lt; major) || ((LLVM_MAJOR == major) &amp;&amp; (LLVM_MINOR &lt; minor)))</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#define LLVM_AFTER(major,minor)\</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">    ((LLVM_MAJOR &gt; major) || ((LLVM_MAJOR == major) &amp;&amp; (LLVM_MINOR &gt; minor)))</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;llvm/Analysis/Passes.h&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &lt;llvm/Bitcode/ReaderWriter.h&gt;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;llvm/ExecutionEngine/ExecutionEngine.h&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;llvm/ExecutionEngine/GenericValue.h&gt;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &lt;llvm/IR/Constants.h&gt;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;llvm/IR/DataLayout.h&gt;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;llvm/IR/DerivedTypes.h&gt;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &lt;llvm/IR/GlobalVariable.h&gt;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &lt;llvm/IR/IRBuilder.h&gt;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &lt;llvm/IR/LLVMContext.h&gt;</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &lt;llvm/IR/Module.h&gt;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#if LLVM_BEFORE(3,5)</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &lt;llvm/Support/system_error.h&gt;</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &lt;llvm/Analysis/Verifier.h&gt;</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &lt;llvm/Linker.h&gt;</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;llvm/IR/Verifier.h&gt;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;llvm/Linker/Linker.h&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;llvm/PassManager.h&gt;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &lt;llvm/Support/MemoryBuffer.h&gt;</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &lt;llvm/Support/TargetSelect.h&gt;</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &lt;llvm/Transforms/IPO/PassManagerBuilder.h&gt;</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &lt;llvm/Transforms/IPO.h&gt;</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &quot;ast.hh&quot;</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacellvm.html">llvm</a>;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespace_compiler.html">Compiler</a></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;{</div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html">   60</a></span>&#160;<span class="keyword">struct </span><a class="code" href="struct_compiler_1_1_state.html">State</a></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;{</div>
<div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a513b7a9f2bb90fae062653b7bd244fcc">   63</a></span>&#160;    LLVMContext &amp;<a class="code" href="struct_compiler_1_1_state.html#a513b7a9f2bb90fae062653b7bd244fcc">C</a>;</div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a9f10323988336a9aafefe19aa7e83d20">   65</a></span>&#160;    Module *<a class="code" href="struct_compiler_1_1_state.html#a9f10323988336a9aafefe19aa7e83d20">Mod</a>;</div>
<div class="line"><a name="l00067"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#aeffc5f38ab54aeb14296593180d28b76">   67</a></span>&#160;    Function *<a class="code" href="struct_compiler_1_1_state.html#aeffc5f38ab54aeb14296593180d28b76">F</a>;</div>
<div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">   69</a></span>&#160;    IRBuilder&lt;&gt; <a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>;</div>
<div class="line"><a name="l00071"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a62ca1e3cb407c1de9760f360384545e3">   71</a></span>&#160;    Value *a[10];</div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a9142fde39321cfe7c35fc87d8b764fd8">   73</a></span>&#160;    Value *g[10];</div>
<div class="line"><a name="l00075"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a17f80c6745da0f266a62142ef18e4dad">   75</a></span>&#160;    Value *<a class="code" href="struct_compiler_1_1_state.html#a17f80c6745da0f266a62142ef18e4dad">oldGrid</a>;</div>
<div class="line"><a name="l00077"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a3a949d5132b7854fee15d6d13344652c">   77</a></span>&#160;    Value *<a class="code" href="struct_compiler_1_1_state.html#a3a949d5132b7854fee15d6d13344652c">newGrid</a>;</div>
<div class="line"><a name="l00079"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a8a8d926b5bdc164b0999d389d64bfef6">   79</a></span>&#160;    Value *<a class="code" href="struct_compiler_1_1_state.html#a8a8d926b5bdc164b0999d389d64bfef6">width</a>;</div>
<div class="line"><a name="l00081"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a26cd163bda6abc1046bfde5aceda1e7c">   81</a></span>&#160;    Value *<a class="code" href="struct_compiler_1_1_state.html#a26cd163bda6abc1046bfde5aceda1e7c">height</a>;</div>
<div class="line"><a name="l00083"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#acaa847aec898fb2d1c76f71ca32cdc64">   83</a></span>&#160;    Value *<a class="code" href="struct_compiler_1_1_state.html#acaa847aec898fb2d1c76f71ca32cdc64">x</a>;</div>
<div class="line"><a name="l00085"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a57aff95b64b5cc46f68199d73ca075fa">   85</a></span>&#160;    Value *<a class="code" href="struct_compiler_1_1_state.html#a57aff95b64b5cc46f68199d73ca075fa">y</a>;</div>
<div class="line"><a name="l00089"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a81576df1e83e8029213bca148f4343f4">   89</a></span>&#160;    Value *<a class="code" href="struct_compiler_1_1_state.html#a81576df1e83e8029213bca148f4343f4">v</a>;</div>
<div class="line"><a name="l00091"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#aeb8aeba08c21971bcdaac5935a77f629">   91</a></span>&#160;    Type *<a class="code" href="struct_compiler_1_1_state.html#aeb8aeba08c21971bcdaac5935a77f629">regTy</a>;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a0e3254ab960e92efbc16bff48496ec79">   98</a></span>&#160;    <a class="code" href="struct_compiler_1_1_state.html#a0e3254ab960e92efbc16bff48496ec79">State</a>() : C(getGlobalContext()), B(C)</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    {</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="comment">// Load the bitcode for the runtime helper code</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#if LLVM_BEFORE(3,5)</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        OwningPtr&lt;MemoryBuffer&gt; buffer;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        error_code ec = MemoryBuffer::getFile(<span class="stringliteral">&quot;runtime.bc&quot;</span>, buffer);</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <span class="keywordflow">if</span> (ec)</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            std::cerr &lt;&lt; <span class="stringliteral">&quot;Failed to open runtime.bc: &quot;</span> &lt;&lt; ec.message() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        }</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        Mod = ParseBitcodeFile(buffer.get(), C);</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        <span class="keyword">auto</span> buffer = MemoryBuffer::getFile(<span class="stringliteral">&quot;runtime.bc&quot;</span>);</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        std::error_code ec;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="keywordflow">if</span> ((ec = buffer.getError()))</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        {</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            std::cerr &lt;&lt; <span class="stringliteral">&quot;Failed to open runtime.bc: &quot;</span> &lt;&lt; ec.message() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        ErrorOr&lt;Module*&gt; e = parseBitcodeFile(buffer.get().get(), C);</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <span class="keywordflow">if</span> ((ec = e.getError()))</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            std::cerr &lt;&lt; <span class="stringliteral">&quot;Failed to parse runtime.bc: &quot;</span> &lt;&lt; ec.message() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;            exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        }</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        Mod = e.get();</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="comment">// Get the stub (prototype) for the cell function</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        F = Mod-&gt;getFunction(<span class="stringliteral">&quot;cell&quot;</span>);</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="comment">// Set it to have private linkage, so that it can be removed after being</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="comment">// inlined.</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        F-&gt;setLinkage(GlobalValue::PrivateLinkage);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="comment">// Add an entry basic block to this function and set it</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        BasicBlock *entry = BasicBlock::Create(C, <span class="stringliteral">&quot;entry&quot;</span>, F);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        B.SetInsertPoint(entry);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        <span class="comment">// Cache the type of registers</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        regTy = Type::getInt16Ty(C);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        <span class="comment">// Collect the function parameters</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="keyword">auto</span> args = F-&gt;arg_begin();</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        oldGrid = args++;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        newGrid = args++;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        width = args++;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        height = args++;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        x = args++;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        y = args++;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="comment">// Create space on the stack for the local registers</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0 ; i&lt;10 ; i++)</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        {</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            a[i] = B.CreateAlloca(regTy);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <span class="comment">// Create a space on the stack for the current value.  This can be</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="comment">// assigned to, and will be returned at the end.  Store the value passed</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        <span class="comment">// as a parameter in this.</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        v = B.CreateAlloca(regTy);</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        B.CreateStore(args++, v);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        <span class="comment">// Create a load of pointers to the global registers.</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        Value *gArg = args;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0 ; i&lt;10 ; i++)</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        {</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            B.CreateStore(ConstantInt::get(regTy, 0), a[i]);</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            g[i] = B.CreateConstGEP1_32(gArg, i);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        }</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno"><a class="line" href="struct_compiler_1_1_state.html#a8b4d1a0178f7f7366f1a30e76db8e0db">  170</a></span>&#160;    automaton <a class="code" href="struct_compiler_1_1_state.html#a8b4d1a0178f7f7366f1a30e76db8e0db">getAutomaton</a>(<span class="keywordtype">int</span> optimiseLevel)</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    {</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <span class="comment">// We&#39;ve finished generating code, so add a return statement - we&#39;re</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="comment">// returning the value of the v register.</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        B.CreateRet(B.CreateLoad(v));</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="preprocessor">#ifdef DEBUG_CODEGEN</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="comment">// If we&#39;re debugging, then print the module in human-readable form to</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="comment">// the standard error and verify it.</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        Mod-&gt;dump();</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        verifyModule(*Mod);</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <span class="comment">// Now we need to construct the set of optimisations that we&#39;re going to</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <span class="comment">// run.</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        PassManagerBuilder PMBuilder;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="comment">// Set the optimisation level.  This defines what optimisation passes</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="comment">// will be added.</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        PMBuilder.OptLevel = optimiseLevel;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="comment">// Create a basic inliner.  This will inline the cell function that we&#39;ve</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="comment">// just created into the automaton function that we&#39;re going to create.</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        PMBuilder.Inliner = createFunctionInliningPass(275);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="comment">// Now create a function pass manager that is responsible for running</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="comment">// passes that optimise functions, and populate it.</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        FunctionPassManager *PerFunctionPasses= <span class="keyword">new</span> FunctionPassManager(Mod);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        PMBuilder.populateFunctionPassManager(*PerFunctionPasses);</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="comment">// Run all of the function passes on the functions in our module</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;I : *Mod)</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        {</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            <span class="keywordflow">if</span> (!I.isDeclaration())</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            {</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                PerFunctionPasses-&gt;run(I);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;            }</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        }</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <span class="comment">// Clean up</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        PerFunctionPasses-&gt;doFinalization();</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        <span class="keyword">delete</span> PerFunctionPasses;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="comment">// Run the per-module passes</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        PassManager *PerModulePasses = <span class="keyword">new</span> PassManager();</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        PMBuilder.populateModulePassManager(*PerModulePasses);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        PerModulePasses-&gt;run(*Mod);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keyword">delete</span> PerModulePasses;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="comment">// Now we are ready to generate some code.  First create the execution</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="comment">// engine (JIT)</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        std::string error;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        ExecutionEngine *EE = ExecutionEngine::create(Mod, <span class="keyword">false</span>, &amp;error);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="keywordflow">if</span> (!EE)</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        {</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            fprintf(stderr, <span class="stringliteral">&quot;Error: %s\n&quot;</span>, error.c_str());</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;            exit(-1);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        }</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        <span class="comment">// Now tell it to compile</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="keywordflow">return</span> (automaton)EE-&gt;getPointerToFunction(Mod-&gt;getFunction(<span class="stringliteral">&quot;automaton&quot;</span>));</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    }</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;};</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;automaton compile(<a class="code" href="struct_a_s_t_1_1_statement_list.html">AST::StatementList</a> *ast, <span class="keywordtype">int</span> optimiseLevel)</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;{</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="comment">// These functions do nothing, they just ensure that the correct modules are</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="comment">// not removed by the linker.</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    InitializeNativeTarget();</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    LLVMLinkInJIT();</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    </div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    State s;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    ast-&gt;<a class="code" href="struct_a_s_t_1_1_statement_list.html#a6e0377c7ed32575ad3e005ae8e88285b">compile</a>(s);</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="comment">// And then return the compiled version.</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordflow">return</span> s.getAutomaton(optimiseLevel);</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;}</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;} <span class="comment">// namespace Compiler</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespace_a_s_t.html">AST</a></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;{</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div>
<div class="line"><a name="l00245"></a><span class="lineno"><a class="line" href="struct_a_s_t_1_1_literal.html#af0e2e0866feb2e80161e3c2e48b39a6e">  245</a></span>&#160;Value* Literal::compile(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s)</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;{</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordflow">return</span> ConstantInt::get(s.<a class="code" href="struct_compiler_1_1_state.html#aeb8aeba08c21971bcdaac5935a77f629">regTy</a>, value);</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;}</div>
<div class="line"><a name="l00249"></a><span class="lineno"><a class="line" href="struct_a_s_t_1_1_local_register.html#a98ed316a840808ff8b1a18b2a3ad4c2f">  249</a></span>&#160;Value* LocalRegister::compile(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s)</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;{</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    assert(registerNumber &gt;= 0 &amp;&amp; registerNumber &lt; 10);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="keywordflow">return</span> s.<a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>.CreateLoad(s.<a class="code" href="struct_compiler_1_1_state.html#a62ca1e3cb407c1de9760f360384545e3">a</a>[registerNumber]);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;}</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="keywordtype">void</span> LocalRegister::assign(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s, Value* val)</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;{</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    assert(registerNumber &gt;= 0 &amp;&amp; registerNumber &lt; 10);</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    s.<a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>.CreateStore(val, s.<a class="code" href="struct_compiler_1_1_state.html#a62ca1e3cb407c1de9760f360384545e3">a</a>[registerNumber]);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;}</div>
<div class="line"><a name="l00259"></a><span class="lineno"><a class="line" href="struct_a_s_t_1_1_global_register.html#a4621cf8ad9899aad665fecf06f44fa92">  259</a></span>&#160;Value* GlobalRegister::compile(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s)</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;{</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    assert(registerNumber &gt;= 0 &amp;&amp; registerNumber &lt; 10);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordflow">return</span> s.<a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>.CreateLoad(s.<a class="code" href="struct_compiler_1_1_state.html#a9142fde39321cfe7c35fc87d8b764fd8">g</a>[registerNumber]);</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;}</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="keywordtype">void</span> GlobalRegister::assign(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s, Value* val)</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;{</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    assert(registerNumber &gt;= 0 &amp;&amp; registerNumber &lt; 10);</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    s.<a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>.CreateStore(val, s.<a class="code" href="struct_compiler_1_1_state.html#a9142fde39321cfe7c35fc87d8b764fd8">g</a>[registerNumber]);</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;}</div>
<div class="line"><a name="l00269"></a><span class="lineno"><a class="line" href="struct_a_s_t_1_1_v_register.html#a3d8a1a390663451504f5a9fe253d08ef">  269</a></span>&#160;Value* VRegister::compile(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s)</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;{</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordflow">return</span> s.<a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>.CreateLoad(s.<a class="code" href="struct_compiler_1_1_state.html#a81576df1e83e8029213bca148f4343f4">v</a>);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;}</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="keywordtype">void</span> VRegister::assign(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s, Value* val)</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;{</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    s.<a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>.CreateStore(val, s.<a class="code" href="struct_compiler_1_1_state.html#a81576df1e83e8029213bca148f4343f4">v</a>);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;}</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div>
<div class="line"><a name="l00278"></a><span class="lineno"><a class="line" href="struct_a_s_t_1_1_arithmetic.html#ace5103dd76bdcd2f8895e3e61fb1b2bb">  278</a></span>&#160;Value* Arithmetic::compile(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s)</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;{</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="comment">// Keep a reference to the builder so we don&#39;t have to type s.B everywhere</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    IRBuilder&lt;&gt; &amp;B = s.<a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    Value *v = value-&gt;compile(s);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    Value *o = target-&gt;compile(s);</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    Value *result;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="comment">// For most operations, we can just create a single IR instruction and then</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="comment">// store the result.  For min and max, we create a comparison and a select</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordflow">switch</span> (op-&gt;op)</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    {</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        <span class="keywordflow">case</span> Op::Add:</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;            result = B.CreateAdd(v, o);</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="keywordflow">case</span> Op::Assign:</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;            result = v;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keywordflow">case</span> Op::Sub:</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            result = B.CreateSub(o, v);</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keywordflow">case</span> Op::Mul:</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            result = B.CreateMul(o, v);</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        <span class="keywordflow">case</span> Op::Div:</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            result = B.CreateSDiv(o, v);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        <span class="keywordflow">case</span> Op::Min:</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        {</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            Value *gt = B.CreateICmpSGT(o, v);</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;            result = B.CreateSelect(gt, v, o);</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        }</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        <span class="keywordflow">case</span> Op::Max:</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        {</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            Value *gt = B.CreateICmpSGT(o, v);</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            result = B.CreateSelect(gt, o, v);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        }</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    }</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    target-&gt;assign(s, result);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="keywordflow">return</span> target-&gt;compile(s);</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;}</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div>
<div class="line"><a name="l00321"></a><span class="lineno"><a class="line" href="struct_a_s_t_1_1_range_expr.html#a69356faa0f30199f6f7af2c226e32b54">  321</a></span>&#160;Value* RangeExpr::compile(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;{</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="comment">// Keep a reference to the builder so we don&#39;t have to type s.B everywhere</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    IRBuilder&lt;&gt; &amp;B = s.<a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    LLVMContext &amp;C = s.<a class="code" href="struct_compiler_1_1_state.html#a513b7a9f2bb90fae062653b7bd244fcc">C</a>;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    Function    *F = s.<a class="code" href="struct_compiler_1_1_state.html#aeffc5f38ab54aeb14296593180d28b76">F</a>;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="comment">// Load the register that we&#39;re mapping</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    Value *reg = value-&gt;compile(s);</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="comment">// Now create a basic block for continuation.  This is the block that</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="comment">// will be reached after the range expression.</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    BasicBlock *cont = BasicBlock::Create(s.<a class="code" href="struct_compiler_1_1_state.html#a513b7a9f2bb90fae062653b7bd244fcc">C</a>, <span class="stringliteral">&quot;range_continue&quot;</span>, s.<a class="code" href="struct_compiler_1_1_state.html#aeffc5f38ab54aeb14296593180d28b76">F</a>);</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="comment">// In this block, create a PHI node that contains the result.</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    PHINode *phi = PHINode::Create(s.<a class="code" href="struct_compiler_1_1_state.html#aeb8aeba08c21971bcdaac5935a77f629">regTy</a>, ranges.objects().size(),</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                                   <span class="stringliteral">&quot;range_result&quot;</span>, cont);</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="comment">// Now loop over all of the possible ranges and create a test for each one</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    BasicBlock *current = B.GetInsertBlock();</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;re : ranges.objects())</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    {</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        Value *match;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        <span class="comment">// If there is just one range value then we just need an</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        <span class="comment">// equals-comparison</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        <span class="keywordflow">if</span> (re-&gt;start.get() == <span class="keyword">nullptr</span>)</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        {</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            Value *val = re-&gt;end-&gt;compile(s);</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            match = B.CreateICmpEQ(reg, val);</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        }</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        {</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            <span class="comment">// Otherwise we need to emit both values and then compare if</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            <span class="comment">// we&#39;re greater-than-or-equal-to the smaller, and</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;            <span class="comment">// less-than-or-equal-to the larger.</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;            Value *min = re-&gt;start-&gt;compile(s);</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;            Value *max = re-&gt;end-&gt;compile(s);</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;            match = B.CreateAnd(B.CreateICmpSGE(reg, min),</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                                B.CreateICmpSLE(reg, max));</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        }</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="comment">// The match value is now a boolean (i1) indicating whether the</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <span class="comment">// value matches this range.  Create a pair of basic blocks, one</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <span class="comment">// for the case where we did match the specified range, and one for</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        <span class="comment">// the case where we didn&#39;t.</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        BasicBlock *expr = BasicBlock::Create(C, <span class="stringliteral">&quot;range_result&quot;</span>, F);</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        BasicBlock *next = BasicBlock::Create(C, <span class="stringliteral">&quot;range_next&quot;</span>, F);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <span class="comment">// Branch to the correct block</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        B.CreateCondBr(match, expr, next);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        <span class="comment">// Now construct the block for the case where we matched a value</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        B.SetInsertPoint(expr);</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        <span class="comment">// Compiling the statement may emit some complex code, so we need to</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <span class="comment">// leave everything set up for it to (potentially) write lots of</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <span class="comment">// instructions and create more basic blocks (imagine nested range</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="comment">// expressions).  If this is just a constant, then the next basic block</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        <span class="comment">// will be empty, but the SimplifyCFG pass will remove it.</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        Value *output = re-&gt;value-&gt;compile(s);</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        phi-&gt;addIncoming(output, B.GetInsertBlock());</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        <span class="comment">//phi-&gt;addIncoming(re-&gt;value-&gt;compile(s), B.GetInsertBlock());</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        <span class="comment">// Now that we&#39;ve generated the correct value, branch to the</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        <span class="comment">// continuation block.</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        B.CreateBr(cont);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="comment">// ...and repeat</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        current = next;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        B.SetInsertPoint(current);</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    }</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="comment">// If we&#39;ve fallen off the end, set the default value of zero and branch to</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="comment">// the continuation point.</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    B.CreateBr(cont);</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    phi-&gt;addIncoming(ConstantInt::get(s.<a class="code" href="struct_compiler_1_1_state.html#aeb8aeba08c21971bcdaac5935a77f629">regTy</a>, 0), B.GetInsertBlock());</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    B.SetInsertPoint(cont);</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">return</span> phi;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;}</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div>
<div class="line"><a name="l00390"></a><span class="lineno"><a class="line" href="struct_a_s_t_1_1_neighbours.html#aeaf1e87081023870cfdaeee872048f13">  390</a></span>&#160;Value* Neighbours::compile(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a> &amp;s)</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;{</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="comment">// Grab some local names for things in state</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    IRBuilder&lt;&gt; &amp;B = s.<a class="code" href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">B</a>;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    Value *x = s.<a class="code" href="struct_compiler_1_1_state.html#acaa847aec898fb2d1c76f71ca32cdc64">x</a>;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    Value *y = s.<a class="code" href="struct_compiler_1_1_state.html#a57aff95b64b5cc46f68199d73ca075fa">y</a>;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    Value *width = s.<a class="code" href="struct_compiler_1_1_state.html#a8a8d926b5bdc164b0999d389d64bfef6">width</a>;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    Value *height = s.<a class="code" href="struct_compiler_1_1_state.html#a26cd163bda6abc1046bfde5aceda1e7c">height</a>;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    Type  *regTy = s.<a class="code" href="struct_compiler_1_1_state.html#aeb8aeba08c21971bcdaac5935a77f629">regTy</a>;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    LLVMContext &amp;C = s.<a class="code" href="struct_compiler_1_1_state.html#a513b7a9f2bb90fae062653b7bd244fcc">C</a>;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    Function    *F = s.<a class="code" href="struct_compiler_1_1_state.html#aeffc5f38ab54aeb14296593180d28b76">F</a>;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="comment">// Some useful constants.</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    Value *Zero  = ConstantInt::get(regTy, 0);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    Value *One  = ConstantInt::get(regTy, 1);</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="comment">// For each of the (valid) neighbours Start by identifying the bounds</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    Value *XMin = B.CreateSub(x, One);</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    Value *XMax = B.CreateAdd(x, One);</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    Value *YMin = B.CreateSub(y, One);</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    Value *YMax = B.CreateAdd(y, One);</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="comment">// Now clamp them to the grid</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    XMin = B.CreateSelect(B.CreateICmpSLT(XMin, Zero), x, XMin);</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    YMin = B.CreateSelect(B.CreateICmpSLT(YMin, Zero), y, YMin);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    XMax = B.CreateSelect(B.CreateICmpSGE(XMax, width), x, XMax);</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    YMax = B.CreateSelect(B.CreateICmpSGE(YMax, height), y, YMax);</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="comment">// Now create the loops.  We&#39;re going to create two nested loops, an outer</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="comment">// one for x and an inner one for y.</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    BasicBlock *start = B.GetInsertBlock();</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    <span class="comment">// The entry basic blocks for the outer and inner loops.</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    BasicBlock *xLoopStart = BasicBlock::Create(C, <span class="stringliteral">&quot;x_loop_start&quot;</span>, F);</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    BasicBlock *yLoopStart = BasicBlock::Create(C, <span class="stringliteral">&quot;y_loop_start&quot;</span>, F);</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="comment">// Branch to the start of the outer loop and start inserting instructions there</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    B.CreateBr(xLoopStart);</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    B.SetInsertPoint(xLoopStart);</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="comment">// Create the Phi node representing the x index and fill in its value for</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    <span class="comment">// the initial entry into the loop.  We&#39;ll fill in its value for back</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="comment">// branches later.</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    PHINode *XPhi = B.CreatePHI(regTy, 2);</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    XPhi-&gt;addIncoming(XMin, start);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="comment">// Branch to the inner loop and set up the y value in the same way.</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    B.CreateBr(yLoopStart);</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    B.SetInsertPoint(yLoopStart);</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    PHINode *YPhi = B.CreatePHI(regTy, 2);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    YPhi-&gt;addIncoming(YMin, xLoopStart);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="comment">// Create basic blocks for the end of the inner (y) loop and for the loop body</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    BasicBlock *endY = BasicBlock::Create(C, <span class="stringliteral">&quot;y_loop_end&quot;</span>, F);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    BasicBlock *body = BasicBlock::Create(C, <span class="stringliteral">&quot;body&quot;</span>, F);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="comment">// If we&#39;re in the (x,y) point, we&#39;re not in a neighbour, so skip the</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <span class="comment">// current loop iteration</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    B.CreateCondBr(B.CreateAnd(B.CreateICmpEQ(x, XPhi),</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                               B.CreateICmpEQ(y, YPhi)),</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                   endY, body);</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="comment">// Now we start emitting the body of the loop</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    B.SetInsertPoint(body);</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    <span class="comment">// For larger grid sizes, we need to make sure that we&#39;re doing i32</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="comment">// arithmetic, or we&#39;ll overflow</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    IntegerType *i32 = IntegerType::get(C, 32);</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    Value *x32 = B.CreateZExt(XPhi, i32);</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    Value *y32 = B.CreateZExt(YPhi, i32);</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    Value *height32 = B.CreateZExt(height, i32);</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="comment">// Compute the address of the grid</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    Value *idx = B.CreateAdd(y32, B.CreateMul(x32, height32));</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="comment">// Load the value at the current grid point into a0</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    B.CreateStore(B.CreateLoad(B.CreateGEP(s.<a class="code" href="struct_compiler_1_1_state.html#a17f80c6745da0f266a62142ef18e4dad">oldGrid</a>, idx)), s.<a class="code" href="struct_compiler_1_1_state.html#a62ca1e3cb407c1de9760f360384545e3">a</a>[0]);</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    <span class="comment">// Compile each of the statements inside the loop</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    statements-&gt;compile(s);</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="comment">// Branch to endY.  This is needed if any of the statements have created</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="comment">// basic blocks.</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    B.CreateBr(endY);</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    B.SetInsertPoint(endY);</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    BasicBlock *endX = BasicBlock::Create(C, <span class="stringliteral">&quot;x_loop_end&quot;</span>, F);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    BasicBlock *cont = BasicBlock::Create(C, <span class="stringliteral">&quot;continue&quot;</span>, F);</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="comment">// Increment the loop country for the next iteration</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    YPhi-&gt;addIncoming(B.CreateAdd(YPhi, ConstantInt::get(regTy, 1)), endY);</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    B.CreateCondBr(B.CreateICmpEQ(YPhi, YMax), endX, yLoopStart);</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    B.SetInsertPoint(endX);</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    XPhi-&gt;addIncoming(B.CreateAdd(XPhi, ConstantInt::get(regTy, 1)), endX);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    B.CreateCondBr(B.CreateICmpEQ(XPhi, XMax), cont, xLoopStart);</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    B.SetInsertPoint(cont);</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;}</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div>
<div class="line"><a name="l00478"></a><span class="lineno"><a class="line" href="struct_a_s_t_1_1_statement_list.html#a6e0377c7ed32575ad3e005ae8e88285b">  478</a></span>&#160;Value* StatementList::compile(<a class="code" href="struct_compiler_1_1_state.html">Compiler::State</a>&amp; state)</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;{</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;s: statements.objects())</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    {</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        s-&gt;compile(state);</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    }</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;}</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;} <span class="comment">// namespace AST</span></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a26cd163bda6abc1046bfde5aceda1e7c"><div class="ttname"><a href="struct_compiler_1_1_state.html#a26cd163bda6abc1046bfde5aceda1e7c">Compiler::State::height</a></div><div class="ttdeci">Value * height</div><div class="ttdoc">The height of the grid (passed as an argument) </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00081">compiler.cc:81</a></div></div>
<div class="ttc" id="namespacellvm_html"><div class="ttname"><a href="namespacellvm.html">llvm</a></div><div class="ttdef"><b>Definition:</b> <a href="ast_8hh_source.html#l00067">ast.hh:67</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html"><div class="ttname"><a href="struct_compiler_1_1_state.html">Compiler::State</a></div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00060">compiler.cc:60</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a513b7a9f2bb90fae062653b7bd244fcc"><div class="ttname"><a href="struct_compiler_1_1_state.html#a513b7a9f2bb90fae062653b7bd244fcc">Compiler::State::C</a></div><div class="ttdeci">LLVMContext &amp; C</div><div class="ttdoc">LLVM uses a context object to allow multiple threads. </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00063">compiler.cc:63</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a17f80c6745da0f266a62142ef18e4dad"><div class="ttname"><a href="struct_compiler_1_1_state.html#a17f80c6745da0f266a62142ef18e4dad">Compiler::State::oldGrid</a></div><div class="ttdeci">Value * oldGrid</div><div class="ttdoc">The input grid (passed as an argument) </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00075">compiler.cc:75</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_aeb8aeba08c21971bcdaac5935a77f629"><div class="ttname"><a href="struct_compiler_1_1_state.html#aeb8aeba08c21971bcdaac5935a77f629">Compiler::State::regTy</a></div><div class="ttdeci">Type * regTy</div><div class="ttdoc">The type of our registers (currently i16) </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00091">compiler.cc:91</a></div></div>
<div class="ttc" id="struct_a_s_t_1_1_statement_list_html"><div class="ttname"><a href="struct_a_s_t_1_1_statement_list.html">AST::StatementList</a></div><div class="ttdoc">A list of statements that will be executed sequentially. </div><div class="ttdef"><b>Definition:</b> <a href="ast_8hh_source.html#l00094">ast.hh:94</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_aeffc5f38ab54aeb14296593180d28b76"><div class="ttname"><a href="struct_compiler_1_1_state.html#aeffc5f38ab54aeb14296593180d28b76">Compiler::State::F</a></div><div class="ttdeci">Function * F</div><div class="ttdoc">The function representing the program. </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00067">compiler.cc:67</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_acaa847aec898fb2d1c76f71ca32cdc64"><div class="ttname"><a href="struct_compiler_1_1_state.html#acaa847aec898fb2d1c76f71ca32cdc64">Compiler::State::x</a></div><div class="ttdeci">Value * x</div><div class="ttdoc">The x coordinate of the current cell (passed as an argument) </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00083">compiler.cc:83</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a62ca1e3cb407c1de9760f360384545e3"><div class="ttname"><a href="struct_compiler_1_1_state.html#a62ca1e3cb407c1de9760f360384545e3">Compiler::State::a</a></div><div class="ttdeci">Value * a[10]</div><div class="ttdoc">The 10 local registers in the source language. </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00071">compiler.cc:71</a></div></div>
<div class="ttc" id="namespace_compiler_html"><div class="ttname"><a href="namespace_compiler.html">Compiler</a></div><div class="ttdef"><b>Definition:</b> <a href="ast_8hh_source.html#l00047">ast.hh:47</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a8a8d926b5bdc164b0999d389d64bfef6"><div class="ttname"><a href="struct_compiler_1_1_state.html#a8a8d926b5bdc164b0999d389d64bfef6">Compiler::State::width</a></div><div class="ttdeci">Value * width</div><div class="ttdoc">The width of the grid (passed as an argument) </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00079">compiler.cc:79</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a9142fde39321cfe7c35fc87d8b764fd8"><div class="ttname"><a href="struct_compiler_1_1_state.html#a9142fde39321cfe7c35fc87d8b764fd8">Compiler::State::g</a></div><div class="ttdeci">Value * g[10]</div><div class="ttdoc">The 10 global registers in the source language. </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00073">compiler.cc:73</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a5ba78d7546e9c19aac0e59064f93053a"><div class="ttname"><a href="struct_compiler_1_1_state.html#a5ba78d7546e9c19aac0e59064f93053a">Compiler::State::B</a></div><div class="ttdeci">IRBuilder B</div><div class="ttdoc">A helper class for generating instructions. </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00069">compiler.cc:69</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a57aff95b64b5cc46f68199d73ca075fa"><div class="ttname"><a href="struct_compiler_1_1_state.html#a57aff95b64b5cc46f68199d73ca075fa">Compiler::State::y</a></div><div class="ttdeci">Value * y</div><div class="ttdoc">The y coordinate of the current cell (passed as an argument) </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00085">compiler.cc:85</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a3a949d5132b7854fee15d6d13344652c"><div class="ttname"><a href="struct_compiler_1_1_state.html#a3a949d5132b7854fee15d6d13344652c">Compiler::State::newGrid</a></div><div class="ttdeci">Value * newGrid</div><div class="ttdoc">The output grid (passed as an argument) </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00077">compiler.cc:77</a></div></div>
<div class="ttc" id="namespace_a_s_t_html"><div class="ttname"><a href="namespace_a_s_t.html">AST</a></div><div class="ttdef"><b>Definition:</b> <a href="ast_8hh_source.html#l00026">ast.hh:26</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a81576df1e83e8029213bca148f4343f4"><div class="ttname"><a href="struct_compiler_1_1_state.html#a81576df1e83e8029213bca148f4343f4">Compiler::State::v</a></div><div class="ttdeci">Value * v</div><div class="ttdoc">The value of the current cell (passed as an argument, returned at the end) </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00089">compiler.cc:89</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a9f10323988336a9aafefe19aa7e83d20"><div class="ttname"><a href="struct_compiler_1_1_state.html#a9f10323988336a9aafefe19aa7e83d20">Compiler::State::Mod</a></div><div class="ttdeci">Module * Mod</div><div class="ttdoc">The compilation unit that we are generating. </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00065">compiler.cc:65</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a8b4d1a0178f7f7366f1a30e76db8e0db"><div class="ttname"><a href="struct_compiler_1_1_state.html#a8b4d1a0178f7f7366f1a30e76db8e0db">Compiler::State::getAutomaton</a></div><div class="ttdeci">automaton getAutomaton(int optimiseLevel)</div><div class="ttdoc">Returns a function pointer for the automaton at the specified optimisation level. ...</div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00170">compiler.cc:170</a></div></div>
<div class="ttc" id="struct_compiler_1_1_state_html_a0e3254ab960e92efbc16bff48496ec79"><div class="ttname"><a href="struct_compiler_1_1_state.html#a0e3254ab960e92efbc16bff48496ec79">Compiler::State::State</a></div><div class="ttdeci">State()</div><div class="ttdoc">Construct the compiler state object. </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00098">compiler.cc:98</a></div></div>
<div class="ttc" id="struct_a_s_t_1_1_statement_list_html_a6e0377c7ed32575ad3e005ae8e88285b"><div class="ttname"><a href="struct_a_s_t_1_1_statement_list.html#a6e0377c7ed32575ad3e005ae8e88285b">AST::StatementList::compile</a></div><div class="ttdeci">virtual llvm::Value * compile(Compiler::State &amp;) override</div><div class="ttdoc">Compile this node, returning the LLVM value representing the result, if there is one. </div><div class="ttdef"><b>Definition:</b> <a href="compiler_8cc_source.html#l00478">compiler.cc:478</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Dec 29 2014 12:56:34 for Pegmatite by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
